<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üßß L√¨ X√¨ T·∫øt üßß</title>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:Arial,sans-serif;
    text-align:center;
    background:linear-gradient(135deg,#b30000,#ff4d4d);
    color:white;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    padding:20px;
}
.container{
    background:rgba(0,0,0,.3);
    border-radius:20px;
    padding:40px;
    max-width:500px;
    width:100%;
    box-shadow:0 10px 40px rgba(0,0,0,.5);
}
h1{font-size:48px;margin-bottom:10px}
.subtitle{font-size:20px;margin-bottom:30px}
button{
    width:100%;
    padding:14px;
    border-radius:8px;
    border:none;
    background:linear-gradient(135deg,#FFD700,#FFA500);
    color:#333;
    font-size:18px;
    font-weight:bold;
    cursor:pointer;
    transition:.3s;
}
button:hover{transform:translateY(-2px)}
.envelope{
    width:250px;
    height:320px;
    margin:30px auto;
    background:linear-gradient(135deg,#c40000,#ff0000);
    border-radius:12px;
    position:relative;
    cursor:pointer;
    transition:.6s;
    box-shadow:0 15px 40px rgba(0,0,0,.4);
    display:none;
    border:3px solid #ffcc00;
}
.envelope::before{
    content:"üßß";
    font-size:120px;
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
}
.envelope.open{
    transform:rotateY(180deg) scale(1.1);
    background:linear-gradient(135deg,#ffd700,#ffaa00);
}
.result{
    margin-top:30px;
    font-size:36px;
    font-weight:bold;
    min-height:50px;
}
.hidden{display:none}
.error{color:#ffcccc}
.success{color:#90EE90}
.remaining{font-size:14px;margin-top:20px}
input{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:none;
    font-size:16px;
}
</style>
</head>

<body>
<div class="container">
<h1>üßß L√å X√å T·∫æT üßß</h1>
<p class="subtitle">Ch√∫c m·ª´ng nƒÉm m·ªõi!</p>

<div id="inputSection">
    <input id="username" type="text" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." />
    <button onclick="validateAndStartGame()">B·∫Øt ƒë·∫ßu</button>
    <div class="remaining">
        <p>S·ªë l√¨ x√¨ c√≤n l·∫°i: <strong id="remainingCount">-</strong></p>
        <p>T·ªïng ti·ªÅn c√≤n: <strong id="remainingAmount">-</strong></p>
    </div>
</div>

<div id="gameSection" class="hidden">
    <p style="font-size:24px;margin-bottom:20px;">
        Xin ch√†o <strong id="playerName"></strong> üëã
    </p>
    <p>B·∫•m v√†o bao ƒë·ªÉ nh·∫≠n l√¨ x√¨!</p>
    <div class="envelope" id="envelope" onclick="openEnvelope()"></div>
    <div id="result" class="result"></div>
    <button onclick="resetGame()" id="nextBtn" style="display:none">Ti·∫øp theo ‚Üí</button>
</div>
</div>

<audio id="openSound" src="https://assets.mixkit.co/sfx/preview/mixkit-fast-small-sweep-transition-166.mp3"></audio>
<audio id="winSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3"></audio>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzNOtXuimvDsCbne5EMtKPzhLmCTS63bOBp_j948U7HnVkCwkHcDza4KNgMBCeeiVG9ZQ/exec";

let poolCount = 0;
let totalAmount = 0;
let isOpened = false;
let currentPlayer = "";

window.onload = async function(){
    await refreshPool();
    document.getElementById("username").focus();
};

async function refreshPool(){
    try{
        const res = await fetch(API_URL);
        const data = await res.json();

        poolCount = data.luckyMoneyPool.length;
        totalAmount = data.luckyMoneyPool.reduce((a,b)=>a+Number(b),0);

        document.getElementById("remainingCount").textContent = poolCount;
        document.getElementById("remainingAmount").textContent = totalAmount + "k";
    }catch(err){
        alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet!");
    }
}

function validateAndStartGame(){
    const name = document.getElementById("username").value.trim();
    if(!name || name.length<2){
        alert("T√™n kh√¥ng h·ª£p l·ªá!");
        return;
    }
    if(poolCount===0){
        alert("H·∫øt l√¨ x√¨ r·ªìi!");
        return;
    }

    currentPlayer=name;
    document.getElementById("playerName").textContent=name;
    document.getElementById("inputSection").classList.add("hidden");
    document.getElementById("gameSection").classList.remove("hidden");
    document.getElementById("envelope").style.display="block";
    document.getElementById("result").innerHTML="";
    document.getElementById("nextBtn").style.display="none";
    isOpened=false;
}

async function openEnvelope(){
    if(isOpened) return;
    isOpened=true;

    const envelope=document.getElementById("envelope");
    envelope.classList.add("open");

    document.getElementById("openSound").play().catch(()=>{});

    setTimeout(async()=>{
        try{
            const res = await fetch(API_URL,{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({action:"pickRandom"})
            });

            const data = await res.json();

            if(!data.success){
                document.getElementById("result").innerHTML=
                '<span class="error">‚ùå H·∫øt l√¨ x√¨!</span>';
                return;
            }

            const prize=data.prize;

            document.getElementById("winSound").play().catch(()=>{});
            document.getElementById("result").innerHTML=
            `<span class="success">üéâ ${prize}k üí∞</span>`;

            launchConfetti(prize);

            await refreshPool();

            if(poolCount>0){
                document.getElementById("nextBtn").style.display="block";
            }else{
                document.getElementById("result").innerHTML+=
                '<p style="font-size:20px;margin-top:20px;">üéä T·∫•t c·∫£ l√¨ x√¨ ƒë√£ h·∫øt! üéä</p>';
            }

        }catch(err){
            document.getElementById("result").innerHTML=
            '<span class="error">L·ªói server!</span>';
        }
    },600);
}

function resetGame(){
    document.getElementById("gameSection").classList.add("hidden");
    document.getElementById("inputSection").classList.remove("hidden");
    document.getElementById("username").value="";
    document.getElementById("envelope").classList.remove("open");
}

function launchConfetti(prize){
    let particles=150;
    if(prize>=200) particles=400;
    else if(prize>=100) particles=250;

    confetti({particleCount:particles,spread:80,origin:{y:.6}});
    setTimeout(()=>{
        confetti({particleCount:particles,spread:120,origin:{y:.4}});
    },400);
}
</script>
</body>
</html>
